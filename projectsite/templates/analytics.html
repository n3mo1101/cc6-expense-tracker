{% extends 'base.html' %}
{% load static %}

{% block title %}Analytics - MoneyLens{% endblock %}

{% block extra_css %}
<style>
    /* Period Selector */
    .period-selector {
        background: white;
        padding: 15px 20px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 25px;
        display: flex;
        gap: 10px;
        overflow-x: auto;
    }

    .period-btn {
        padding: 10px 20px;
        border: 2px solid #e2e8f0;
        background: white;
        border-radius: 8px;
        font-weight: 600;
        color: #64748b;
        cursor: pointer;
        transition: all 0.3s;
        white-space: nowrap;
    }

    .period-btn:hover {
        border-color: #667eea;
        color: #667eea;
    }

    .period-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: transparent;
    }

    /* Summary Cards */
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .summary-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
    }

    .summary-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
    }

    .summary-card.income::before {
        background: linear-gradient(180deg, #10b981 0%, #059669 100%);
    }

    .summary-card.expense::before {
        background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
    }

    .summary-card.savings::before {
        background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
    }

    .summary-card.average::before {
        background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%);
    }

    .summary-label {
        font-size: 13px;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
        font-weight: 600;
    }

    .summary-value {
        font-size: 32px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 10px;
    }

    .summary-change {
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .summary-change.positive {
        color: #10b981;
    }

    .summary-change.negative {
        color: #ef4444;
    }

    /* Chart Containers */
    .chart-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e2e8f0;
    }

    .chart-title {
        font-size: 18px;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
    }

    .chart-container {
        position: relative;
        height: 350px;
    }

    .chart-container.small {
        height: 300px;
    }

    /* Category Breakdown Table */
    .category-table {
        width: 100%;
        border-collapse: collapse;
    }

    .category-table th {
        text-align: left;
        padding: 12px;
        font-size: 12px;
        text-transform: uppercase;
        color: #64748b;
        font-weight: 600;
        border-bottom: 2px solid #e2e8f0;
    }

    .category-table td {
        padding: 15px 12px;
        border-bottom: 1px solid #f1f5f9;
    }

    .category-table tr:hover {
        background: #f8fafc;
    }

    .category-name-cell {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .category-color-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .category-name {
        font-weight: 600;
        color: #1e293b;
    }

    .category-amount {
        font-weight: 600;
        color: #1e293b;
    }

    .category-percentage {
        color: #64748b;
        font-size: 13px;
    }

    .category-bar {
        width: 100%;
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 5px;
    }

    .category-bar-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    /* Insights */
    .insights-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }

    .insight-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .insight-icon {
        width: 40px;
        height: 40px;
        background: rgba(255,255,255,0.2);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
        font-size: 20px;
    }

    .insight-title {
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .insight-description {
        font-size: 14px;
        opacity: 0.9;
        line-height: 1.5;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .summary-grid {
            grid-template-columns: 1fr;
        }

        .chart-container {
            height: 280px;
        }

        .chart-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .period-selector {
            padding: 10px;
        }

        .period-btn {
            padding: 8px 15px;
            font-size: 14px;
        }

        .insights-grid {
            grid-template-columns: 1fr;
        }

        .category-table {
            font-size: 14px;
        }

        .category-table th,
        .category-table td {
            padding: 10px 8px;
        }
    }

    /* Export Button */
    .export-btn {
        padding: 8px 16px;
        background: #f1f5f9;
        border: none;
        border-radius: 8px;
        color: #64748b;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }

    .export-btn:hover {
        background: #e2e8f0;
        color: #1e293b;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <h1 style="font-size: 28px; font-weight: 700; color: #1e293b; margin: 0;">Analytics</h1>
    <p style="color: #64748b; margin-top: 5px;">Detailed insights into your financial patterns</p>
</div>

<!-- Period Selector -->
<div class="period-selector">
    <button class="period-btn" data-period="7">Last 7 Days</button>
    <button class="period-btn active" data-period="30">Last 30 Days</button>
    <button class="period-btn" data-period="90">Last 3 Months</button>
    <button class="period-btn" data-period="180">Last 6 Months</button>
    <button class="period-btn" data-period="365">Last Year</button>
</div>

<!-- Summary Cards -->
<div class="summary-grid">
    <div class="summary-card income">
        <div class="summary-label">Total Income</div>
        <div class="summary-value">₱{{ total_income|default:"0.00" }}</div>
        <div class="summary-change positive">
            <i data-lucide="trending-up" style="width: 16px; height: 16px;"></i>
            <span>+12.5% from last period</span>
        </div>
    </div>

    <div class="summary-card expense">
        <div class="summary-label">Total Expenses</div>
        <div class="summary-value">₱{{ total_expenses|default:"0.00" }}</div>
        <div class="summary-change negative">
            <i data-lucide="trending-down" style="width: 16px; height: 16px;"></i>
            <span>+8.3% from last period</span>
        </div>
    </div>

    <div class="summary-card savings">
        <div class="summary-label">Net Savings</div>
        <div class="summary-value">₱{{ net_savings|default:"0.00" }}</div>
        <div class="summary-change positive">
            <i data-lucide="arrow-up" style="width: 16px; height: 16px;"></i>
            <span>+18.2% from last period</span>
        </div>
    </div>

    <div class="summary-card average">
        <div class="summary-label">Daily Average</div>
        <div class="summary-value">₱{{ daily_average|default:"0.00" }}</div>
        <div class="summary-change">
            <i data-lucide="activity" style="width: 16px; height: 16px;"></i>
            <span>Per day spending</span>
        </div>
    </div>
</div>

<!-- Income vs Expenses Trend -->
<div class="row">
    <div class="col-md-8">
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Income vs Expenses Trend</h3>
                <button class="export-btn">
                    <i data-lucide="download" style="width: 16px; height: 16px;"></i>
                    Export
                </button>
            </div>
            <div class="chart-container">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Expense Distribution</h3>
            </div>
            <div class="chart-container small">
                <canvas id="pieChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Category Breakdown -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Category Breakdown</h3>
                <button class="export-btn">
                    <i data-lucide="download" style="width: 16px; height: 16px;"></i>
                    Export
                </button>
            </div>
            <table class="category-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Percentage</th>
                        <th>Trend</th>
                    </tr>
                </thead>
                <tbody>
                    {% for category in category_breakdown %}
                    <tr>
                        <td>
                            <div class="category-name-cell">
                                <div class="category-color-dot" style="background: {{ category.color }};"></div>
                                <span class="category-name">{{ category.name }}</span>
                            </div>
                        </td>
                        <td class="category-amount">₱{{ category.amount }}</td>
                        <td class="category-percentage">{{ category.percentage }}%</td>
                        <td>
                            <div class="category-bar">
                                <div class="category-bar-fill" 
                                     style="width: {{ category.percentage }}%; background: {{ category.color }};"></div>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px; color: #94a3b8;">
                            No category data available for this period
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Monthly Comparison -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Monthly Comparison</h3>
            </div>
            <div class="chart-container">
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Insights -->
<div class="insights-grid">
    <div class="insight-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
        <div class="insight-icon">
            <i data-lucide="trending-up"></i>
        </div>
        <div class="insight-title">Top Spending Category</div>
        <div class="insight-description">
            Food & Dining accounts for 32% of your expenses this month. Consider meal planning to reduce costs.
        </div>
    </div>

    <div class="insight-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
        <div class="insight-icon">
            <i data-lucide="alert-circle"></i>
        </div>
        <div class="insight-title">Budget Alert</div>
        <div class="insight-description">
            You've used 78% of your monthly budget with 8 days remaining. Consider reducing discretionary spending.
        </div>
    </div>

    <div class="insight-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="insight-icon">
            <i data-lucide="lightbulb"></i>
        </div>
        <div class="insight-title">Savings Opportunity</div>
        <div class="insight-description">
            Your average daily spending decreased by 15% this week. Keep up the good habits!
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Re-initialize Lucide icons
    lucide.createIcons();

    // Period selector
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            const period = this.dataset.period;
            // Reload data based on period
            console.log('Loading data for period:', period);
        });
    });

    // Chart colors
    const colors = {
        primary: '#667eea',
        success: '#10b981',
        danger: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6',
        purple: '#8b5cf6'
    };

    // Income vs Expenses Trend Chart
    const trendCtx = document.getElementById('trendChart');
    if (trendCtx) {
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: {{ trend_labels|safe|default:"[]" }},
                datasets: [{
                    label: 'Income',
                    data: {{ trend_income|safe|default:"[]" }},
                    borderColor: colors.success,
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Expenses',
                    data: {{ trend_expenses|safe|default:"[]" }},
                    borderColor: colors.danger,
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₱' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // Pie Chart
    const pieCtx = document.getElementById('pieChart');
    if (pieCtx) {
        new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: {{ pie_labels|safe|default:"[]" }},
                datasets: [{
                    data: {{ pie_data|safe|default:"[]" }},
                    backgroundColor: [
                        colors.primary,
                        colors.warning,
                        colors.success,
                        colors.danger,
                        colors.purple,
                        colors.info
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    }

    // Monthly Comparison Chart
    const monthlyCtx = document.getElementById('monthlyChart');
    if (monthlyCtx) {
        new Chart(monthlyCtx, {
            type: 'bar',
            data: {
                labels: {{ monthly_labels|safe|default:"[]" }},
                datasets: [{
                    label: 'Income',
                    data: {{ monthly_income|safe|default:"[]" }},
                    backgroundColor: colors.success,
                }, {
                    label: 'Expenses',
                    data: {{ monthly_expenses|safe|default:"[]" }},
                    backgroundColor: colors.danger,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₱' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}