{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - BudgetPro{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
    <div>
        <h1 class="h3 mb-1">Dashboard</h1>
        <p class="text-muted mb-0">Welcome back, {{ user.username }}! Here's your financial overview.</p>
    </div>
    <div class="d-flex gap-2 flex-wrap">
        <a href="{% url 'income' %}" class="btn btn-success">
            <i class="bi bi-plus-lg me-2"></i>
            <span class="d-none d-sm-inline">Add </span>Income
        </a>
        <a href="{% url 'expenses' %}" class="btn btn-danger">
            <i class="bi bi-plus-lg me-2"></i>
            <span class="d-none d-sm-inline">Add </span>Expense
        </a>
    </div>
</div>

<!-- Budget Progress Card -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-6 mb-3 mb-md-0">
                <h6 class="mb-1 text-muted text-uppercase small">Available Budget</h6>
                <h2 class="display-5 fw-bold mb-0">₱{{ available_budget|default:"0.00" }}</h2>
            </div>
            <div class="col-md-6 text-md-end">
                <h6 class="mb-1 text-muted text-uppercase small">Total Budget</h6>
                <h3 class="h2 text-muted mb-0">₱{{ total_budget|default:"0.00" }}</h3>
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="progress mb-2" style="height: 24px;">
            <div class="progress-bar {% if budget_status == 'danger' %}bg-danger{% elif budget_status == 'warning' %}bg-warning{% else %}bg-success{% endif %}" 
                 role="progressbar" 
                 style="width: {{ budget_percentage|default:0 }}%;" 
                 aria-valuenow="{{ budget_percentage|default:0 }}" 
                 aria-valuemin="0" 
                 aria-valuemax="100">
                <span class="fw-semibold">{{ budget_percentage|default:0 }}%</span>
            </div>
        </div>
        
        <div class="d-flex justify-content-between small">
            <span class="text-muted">
                Spent: <strong>₱{{ total_spent|default:"0.00" }}</strong>
            </span>
            <span class="text-muted">
                <i class="bi bi-calendar3"></i>
                {{ days_remaining|default:"0" }} days remaining
            </span>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row g-3 g-lg-4 mb-4">
    <div class="col-6 col-xl-3">
        <div class="card stats-card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="stats-icon bg-success bg-opacity-10 text-success">
                            <i class="bi bi-arrow-up-circle"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="mb-0 text-muted small">Total Income</h6>
                        <h3 class="mb-0 h4 h-md-3">₱{{ total_income|default:"0.00" }}</h3>
                        <small class="text-success">
                            <i class="bi bi-arrow-up"></i> This month
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-6 col-xl-3">
        <div class="card stats-card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="stats-icon bg-danger bg-opacity-10 text-danger">
                            <i class="bi bi-arrow-down-circle"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="mb-0 text-muted small">Total Expenses</h6>
                        <h3 class="mb-0 h4 h-md-3">₱{{ total_expenses|default:"0.00" }}</h3>
                        <small class="text-danger">
                            <i class="bi bi-arrow-down"></i> This month
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-6 col-xl-3">
        <div class="card stats-card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="stats-icon bg-primary bg-opacity-10 text-primary">
                            <i class="bi bi-piggy-bank"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="mb-0 text-muted small">Net Savings</h6>
                        <h3 class="mb-0 h4 h-md-3">₱{{ net_savings|default:"0.00" }}</h3>
                        <small class="text-primary">
                            <i class="bi bi-activity"></i> Income - Expenses
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-6 col-xl-3">
        <div class="card stats-card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="stats-icon bg-warning bg-opacity-10 text-warning">
                            <i class="bi bi-receipt-cutoff"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="mb-0 text-muted small">Transactions</h6>
                        <h3 class="mb-0 h4 h-md-3">{{ total_transactions|default:"0" }}</h3>
                        <small class="text-muted">
                            <i class="bi bi-calendar3"></i> This month
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart Section -->
<div class="row g-3 g-lg-4 mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-3">
                <h5 class="card-title mb-0">Monthly Spending Trend</h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary">7D</button>
                    <button type="button" class="btn btn-outline-primary active">30D</button>
                    <button type="button" class="btn btn-outline-primary">90D</button>
                    <button type="button" class="btn btn-outline-primary d-none d-sm-inline-block">1Y</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="revenueChart" height="250"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Spending by Category</h5>
            </div>
            <div class="card-body">
                <canvas id="categoryChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Recent Transactions -->
<div class="row g-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Recent Transactions</h5>
                <a href="{% url 'transactions' %}" class="btn btn-sm btn-outline-primary">
                    View All
                </a>
            </div>
            {% if recent_transactions %}
                <ul class="transaction-list">
                    {% for transaction in recent_transactions %}
                    <li class="transaction-item">
                        <div class="transaction-icon {{ transaction.type }}">
                            {% if transaction.type == 'income' %}
                                <i class="bi bi-arrow-up"></i>
                            {% else %}
                                <i class="bi bi-arrow-down"></i>
                            {% endif %}
                        </div>
                        <div class="transaction-details">
                            <div class="transaction-category">{{ transaction.category|default:transaction.type|capfirst }}</div>
                            <div class="transaction-date">{{ transaction.date|date:"M d, Y" }}</div>
                        </div>
                        <div class="transaction-amount {{ transaction.type }}">
                            {% if transaction.type == 'income' %}+{% else %}-{% endif %}₱{{ transaction.amount }}
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <h5 class="mt-3">No transactions yet</h5>
                    <p class="text-muted mb-4">Start tracking your finances by adding your first transaction.</p>
                    <div class="d-flex gap-2 justify-content-center flex-wrap">
                        <a href="{% url 'income' %}" class="btn btn-success">
                            <i class="bi bi-plus-lg"></i> Add Income
                        </a>
                        <a href="{% url 'expenses' %}" class="btn btn-danger">
                            <i class="bi bi-plus-lg"></i> Add Expense
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Revenue Chart (Line)
    const revenueCtx = document.getElementById('revenueChart');
    if (revenueCtx) {
        new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: {{ chart_labels|safe|default:"['Week 1', 'Week 2', 'Week 3', 'Week 4']" }},
                datasets: [
                    {
                        label: 'Income',
                        data: {{ chart_income|safe|default:"[5000, 6000, 5500, 7000]" }},
                        borderColor: 'rgb(25, 135, 84)',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    },
                    {
                        label: 'Expenses',
                        data: {{ chart_expenses|safe|default:"[3000, 3500, 4000, 4200]" }},
                        borderColor: 'rgb(220, 53, 69)',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 13
                        },
                        bodyFont: {
                            size: 12
                        },
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += '₱' + context.parsed.y.toLocaleString();
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₱' + value.toLocaleString();
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Category Donut Chart
    const categoryCtx = document.getElementById('categoryChart');
    if (categoryCtx) {
        new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: {{ category_labels|safe|default:"['Food', 'Transport', 'Shopping', 'Bills', 'Others']" }},
                datasets: [{
                    data: {{ category_data|safe|default:"[30, 25, 20, 15, 10]" }},
                    backgroundColor: [
                        'rgb(99, 102, 241)',
                        'rgb(245, 158, 11)',
                        'rgb(25, 135, 84)',
                        'rgb(220, 53, 69)',
                        'rgb(139, 92, 246)'
                    ],
                    borderWidth: 2,
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--bs-body-bg') || '#fff',
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 12,
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                let value = context.parsed;
                                let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                let percentage = ((value / total) * 100).toFixed(1);
                                return label + ': ' + percentage + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    // Update chart colors when theme changes
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.attributeName === 'data-bs-theme') {
                // Update chart border colors when theme changes
                const categoryChart = Chart.getChart('categoryChart');
                if (categoryChart) {
                    const newBorderColor = getComputedStyle(document.documentElement).getPropertyValue('--bs-body-bg') || '#fff';
                    categoryChart.data.datasets[0].borderColor = newBorderColor;
                    categoryChart.update();
                }
            }
        });
    });

    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['data-bs-theme']
    });
</script>
{% endblock %}